{
  "version": 3,
  "sources": ["../../shared/src/index.ts", "../src/effect.ts", "../src/reactiveEffect.ts", "../src/baseHandler.ts", "../src/reactive.ts"],
  "sourcesContent": ["export function isObject(obj) {\r\n  return obj !== null && typeof obj === \"object\";\r\n}\r\n", "export let activeEffect;\r\n\r\nexport function effect(fn: any, options?) {\r\n  const _effect = new ReactiveEffect(fn, () => {\r\n    _effect.run();\r\n  });\r\n\r\n  _effect.run();\r\n\r\n  // \u6DFB\u52A0options\uFF0C\u624B\u52A8\u66F4\u65B0scheduler\r\n  if (options) {\r\n    Object.assign(_effect, options);\r\n  }\r\n  // \u65B9\u4FBF\u7528\u6237\u624B\u52A8\u8C03\u7528\r\n  const runner = _effect.run.bind(_effect);\r\n  // \u66B4\u6F0F\u51FA\u53BBeffect\u7684\u5F15\u7528\r\n  runner.effect = _effect;\r\n  return runner;\r\n}\r\n\r\n/**\r\n * \u4F9D\u8D56\u6536\u96C6\r\n * @param fn \u6267\u884C\u51FD\u6570\r\n * @param scheduler \u89E6\u53D1\u51FD\u6570\uFF0C\u4F1A\u6267\u884Ceffect.run()\u66F4\u65B0\u89C6\u56FE\r\n * @returns ReactiveEffect\r\n * @example effect(() => {})\r\n */\r\nclass ReactiveEffect {\r\n  public active: boolean = true;\r\n  track_id = 0; // \u8BB0\u5F55\u6267\u884C\u7684\u6B21\u6570\uFF0C\u907F\u514D\u540C\u4E00\u4E2A\u5C5E\u6027\u591A\u6B21\u6536\u96C6\r\n  depsLength = 0;\r\n  deps = []; // \u53CD\u5411\u8BB0\u5F55effect\uFF0C\u65B9\u4FBF\u540E\u7EEDdiff\uFF0C\u6700\u5927\u91CF\u590D\u7528\u4F9D\u8D56\r\n\r\n  constructor(public fn: () => void, public scheduler?: () => void) {\r\n    this.fn = fn;\r\n    this.scheduler = scheduler;\r\n  }\r\n\r\n  run() {\r\n    if (!this.active) {\r\n      return this.fn();\r\n    }\r\n    // \u4FDD\u7559\u4E0A\u4E00\u6B21\u7684effect\uFF0C\u907F\u514Deffect \u5D4C\u5957\u5BFC\u81F4effect\u7684\u4F9D\u8D56\u6536\u96C6\u9519\u8BEF\uFF0C\u4FDD\u8BC1\u6700\u540E\u4E00\u6B21\u7684effect\u662F\u6B63\u786E\r\n    let nextActiveEffrct = activeEffect;\r\n    try {\r\n      // \u4FDD\u5B58\u5F53\u524D\u7684effect\u5230\u5168\u5C40\u53D8\u91CF\r\n      activeEffect = this;\r\n      console.log(\"run ...\");\r\n      // \u6E05\u9664\u4E0A\u6B21\u7684\u4F9D\u8D56\r\n      cleanupPreEffect(this);\r\n      return this.fn();\r\n    } finally {\r\n      overflowDepEffect(this);\r\n      activeEffect = nextActiveEffrct;\r\n    }\r\n  }\r\n}\r\n\r\n// \u6E05\u9664\u4E0A\u4E00\u6B21\u7684\u4F9D\u8D56\u5173\u7CFB\uFF0C\u91CD\u65B0diff \u4F9D\u8D56\uFF0C\u6700\u5927\u9650\u5EA6\u590D\u7528\r\nfunction cleanupPreEffect(effect) {\r\n  effect.depsLength = 0;\r\n  effect.track_id++;\r\n}\r\n// \u6E05\u9664\u4F9D\u8D56\r\nfunction cleanupDepEffect(dep, effect) {\r\n  dep.delete(effect);\r\n  if (dep.size == 0) {\r\n    dep?.cleanup();\r\n  }\r\n}\r\n\r\n// \u6EA2\u51FA\u7684\u4F9D\u8D56\uFF0C\u9700\u8981\u6E05\u9664\u6389\r\nfunction overflowDepEffect(effect) {\r\n  if (effect.depsLength < effect.deps.length) {\r\n    for (let i = effect.depsLength; i < effect.deps.length; i++) {\r\n      let dep = effect.deps[i];\r\n      cleanupDepEffect(dep, effect);\r\n    }\r\n  }\r\n}\r\n\r\n/***\r\n * \u6DFB\u52A0\u4F9D\u8D56,\u5982\u679C\u9700\u8981\u91CD\u65B0\u6536\u96C6\u4F9D\u8D56\uFF0C\u5C3D\u53EF\u80FD\u590D\u7528\u65E7\u7684\u4F9D\u8D56\uFF0C\u4E0D\u9700\u8981\u7684\u6E05\u9664\u6389\r\n * @param effect \u5F53\u524D\u7684effect\r\n * @param dep \u5F53\u524D\u7684\u4F9D\u8D56 -> {ReactiveEffect, track_id}\r\n */\r\nexport function trackEffect(effect, dep) {\r\n  // \u4F18\u5316\u591A\u6B21\u6536\u96C6\u76F8\u540C\u5C5E\u6027\r\n  if (effect.track_id !== dep.get(effect)) {\r\n    // \u6DFB\u52A0\u4F9D\u8D56\r\n    dep.set(effect, effect.track_id);\r\n\r\n    // \u53D6\u4E4B\u524D\u7684effect\r\n    const oldDep = effect.deps[effect.depsLength];\r\n    // \u6CA1oldDep\uFF0C\u8BF4\u660E\u662F\u65B0\u7684\u4F9D\u8D56\uFF0C\u9700\u8981\u4FDD\u5B58\u5230effect\u4E2D\r\n    if (oldDep !== dep) {\r\n      // \u4FDD\u5B58\u8FC7\uFF0C\u9700\u8981\u5220\u9664\u65E7\u7684\u4F9D\u8D56\r\n      if (oldDep) {\r\n        cleanupDepEffect(oldDep, effect);\r\n      }\r\n      // \u4FDD\u5B58\u4F9D\u8D56\u5230effect\u4E2D,\u6700\u65B0\u7684dep\r\n      effect.deps[effect.depsLength++] = dep;\r\n    } else {\r\n      // \u76F8\u540C\uFF0C\u8BF4\u660E\u662F\u540C\u4E00\u4E2A\u4F9D\u8D56\uFF0C\u4E0D\u7528\u91CD\u590D\u6536\u96C6,\u6BD4\u8F83\u4E0B\u4E00\u4E2A\r\n      effect.depsLength++;\r\n    }\r\n  }\r\n}\r\n\r\nexport function triggerEffect(dep) {\r\n  const effects = dep.keys();\r\n  effects.forEach((effect) => {\r\n    if (effect.scheduler) {\r\n      effect.scheduler();\r\n    }\r\n  });\r\n}\r\n", "import { activeEffect, triggerEffect, trackEffect } from \"./effect\";\r\n\r\nlet targetMap = new WeakMap();\r\n/**\r\n *\r\n *  {name:'xiaoma',age:18} : {\r\n *\r\n *      name: {\r\n *\r\n *        effect : 0\r\n *      }\r\n *   }\r\n * }\r\n *\r\n */\r\n\r\n// \u4F9D\u8D56\u6536\u96C6\r\nexport function track(target, key) {\r\n  // \u53D6\u5230\u5168\u5C40\u5B58\u7684effect\uFF0C\u6784\u5EFA\u4F9D\u8D56\u5173\u7CFB targer->{map:key->map:effect}\r\n  if (activeEffect) {\r\n    let depMap = targetMap.get(target);\r\n    if (!depMap) {\r\n      targetMap.set(target, (depMap = new Map()));\r\n    }\r\n    let dep = depMap.get(key);\r\n    if (!dep) {\r\n      depMap.set(key, (dep = createDep(() => depMap.delete(key), key)));\r\n    }\r\n    // \u5C06effect \u6536\u96C6\u5230dep\u4E2D\uFF0C\u6784\u5EFA\u6536\u96C6\u5668\u96C6\u5408\r\n    trackEffect(activeEffect, dep);\r\n  }\r\n}\r\n\r\nexport function createDep(cleanup, key) {\r\n  let dep = new Map() as any;\r\n  dep.cleanup = cleanup;\r\n  dep.name = key;\r\n\r\n  return dep;\r\n}\r\n\r\nexport function trigger(targer, key, value, oldValue) {\r\n  let depMap = targetMap.get(targer);\r\n  if (!depMap) {\r\n    return;\r\n  }\r\n\r\n  let dep = depMap.get(key);\r\n  if (dep) {\r\n    triggerEffect(dep);\r\n  }\r\n}\r\n", "import { track, trigger } from \"./reactiveEffect\";\r\nexport enum ReactiveFlags {\r\n  IS_REACTIVE = \"__v_isReactive\", // \u662F\u5426\u662F\u54CD\u5E94\u5F0F\u5BF9\u8C61,\u5982\u679C\u662F\u5219\u4E0D\u5728\u4EE3\u7406\r\n  IS_READONLY = \"__v_isReadonly\",\r\n  RAW = \"__v_raw\",\r\n}\r\n\r\nexport const baseHandlers: ProxyHandler<any> = {\r\n  get(target, key, receiver) {\r\n    if (key === ReactiveFlags.IS_REACTIVE) {\r\n      return true;\r\n    }\r\n\r\n    // \u6536\u96C6\u4F9D\u8D56\r\n    track(target, key);\r\n\r\n    return Reflect.get(target, key, receiver);\r\n  },\r\n\r\n  set(target, key, value, receiver) {\r\n    let oldValue = target[key];\r\n\r\n    let res = Reflect.set(target, key, value, receiver);\r\n    // \u89E6\u53D1\u9875\u9762\u66F4\u65B0\r\n    if (oldValue !== value) {\r\n      trigger(target, key, value, oldValue);\r\n    }\r\n    return res;\r\n  },\r\n};\r\n", "import { isObject } from \"@vue/shared\";\r\nimport { baseHandlers, ReactiveFlags } from \"./baseHandler\";\r\n\r\nexport function reactive(target) {\r\n  return createReactiveObject(target);\r\n}\r\n\r\nfunction createReactiveObject(target) {\r\n  if (!isObject(target)) {\r\n    return true;\r\n  }\r\n  if (target[ReactiveFlags.IS_REACTIVE]) {\r\n    return true;\r\n  }\r\n  const proxy = new Proxy(target, baseHandlers);\r\n\r\n  return proxy;\r\n}\r\n"],
  "mappings": "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",
  "names": ["effect"]
}
